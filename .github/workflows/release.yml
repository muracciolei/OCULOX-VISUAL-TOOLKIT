name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Release Notes
        id: release_notes
        run: |
          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          
          # Create release notes
          cat > release_notes.md << EOF
          ## 🚀 Visual Toolkit for Eye Health $VERSION
          
          ### ✨ Features
          - **🔬 Amsler Grid Test**: Interactive central vision screening with anomaly reporting
          - **🌈 Color & Contrast Check**: Dual-mode testing for color perception and contrast sensitivity  
          - **💪 Eye Wellness Trainer**: Guided exercises with progress tracking and timer-based sessions
          
          ### 🛠️ Technical Highlights
          - Vanilla JavaScript (no frameworks) - lightweight and fast
          - Canvas-based visual tests with accessibility features
          - LocalStorage data persistence for offline functionality
          - WCAG 2.1 compliant with full keyboard navigation
          - Mobile-first responsive design
          - Static site - easy to deploy anywhere
          
          ### 📱 Platform Support
          - ✅ Desktop browsers (Chrome 80+, Firefox 75+, Safari 13+)
          - ✅ Mobile and tablet devices
          - ✅ Touch and keyboard navigation
          - ✅ Screen reader compatibility
          
          ### 🎯 Use Cases
          - Ophthalmologic patient engagement and UX exploration
          - Educational demonstrations of visual tests
          - Eye health awareness and wellness training
          - Accessibility research and development
          
          ### ⚠️ Important Notice
          This is a **DEMONSTRATION tool** for UX exploration with patients under ophthalmologic control.
          
          **NOT a medical device** - for educational and demonstration purposes only.
          Always consult qualified eye care professionals for proper examination and diagnosis.
          
          ### 🔗 Quick Start
          1. **Try the demo**: [Live Demo](https://muracciolei.github.io/OCULOX-VISUAL-TOOLKIT/)
          2. **Download**: Use the assets below or clone the repository
          3. **Run locally**: Open `index.html` in a web browser or serve with any HTTP server
          
          ### 📋 What's Included
          - Complete source code
          - Professional documentation
          - MIT License with medical disclaimer
          - GitHub Actions for automatic deployment
          - Comprehensive README and setup instructions
          
          ---
          
          **Full Documentation**: [README.md](https://github.com/muracciolei/OCULOX-VISUAL-TOOLKIT#readme)
          
          **Made with ❤️ for the visual health community**
          EOF

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: "Visual Toolkit for Eye Health ${{ steps.release_notes.outputs.VERSION }}"
          body_path: release_notes.md
          draft: false
          prerelease: false

      - name: Create ZIP archive
        run: |
          # Create a clean directory for the release
          mkdir -p release-assets
          
          # Copy all necessary files (exclude .git, .github, etc.)
          cp -r amsler color-contrast wellness assets *.html *.css *.json *.md LICENSE release-assets/
          
          # Create ZIP file
          cd release-assets
          zip -r ../visual-toolkit-${{ steps.release_notes.outputs.VERSION }}.zip .
          cd ..

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./visual-toolkit-${{ steps.release_notes.outputs.VERSION }}.zip
          asset_name: visual-toolkit-${{ steps.release_notes.outputs.VERSION }}.zip
          asset_content_type: application/zip